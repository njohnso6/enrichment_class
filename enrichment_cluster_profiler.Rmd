---
title: "R Notebook"
output: html_notebook
---
more info here:https://learn.gencore.bio.nyu.edu/rna-seq-analysis/gene-set-enrichment-analysis/

Important packages are:
1. BiomaRt: allows us to convert from gene symbols, which may change in the literature, to more unique ensembl ids, which are more static across time and link to GO terms.
2. org.Mm.eg.db is a database with that links gene ids with GO terms
3. clusterProfiler: convenience functions so we don't have to code the analyses ourselves.
```{r, results="hide", message=FALSE}
library(biomaRt)
library(org.Mm.eg.db)
library(clusterProfiler)
library(enrichplot)
library(mitch)
library(stringr)
library(dplyr)
library(ggplot2)
library(DOSE)
```

The first step of this analysis is to convert our gene id names, which are fickle, to something more stable and unique. We will also need to map these to GO terms. OrgDbs provide a simple way to do the second part.
```{r}
keytypes(org.Mm.eg.db)
```

```{r}
res_tableOE <- read.csv("/workspaces/enrichment_class/AMvsEM_deseq2_results.csv", row.names = 1)

# check duplicated rownames. Make sure there are none, if so, deal with them
sum(duplicated(rownames(res_tableOE)))

# Can fidn out which biomart to use for gene id mapping
listEnsembl()

ensembl <- useEnsembl(biomart = "genes")
datasets <- listDatasets(ensembl)
searchDatasets(mart = ensembl, pattern = "mus")
ensembl <- useDataset(dataset = "mmusculus_gene_ensembl", mart = ensembl)
# consider specifying a particular version for reproducibility
listEnsemblArchives()
```

Can't tell you all the reasons why, but if you see methods with org.Mm.eg.db take note of which genes don't map. The method is much easier, but often not all genes will map, and it could be that they are old names, or not protein-coding-genesnot spelled correctly, and other reasons. If you do use that method convert from "ALIAS" rather than SYMBOL. You will have better results that way.

Part of the problem is gene name change. If you were to use an older version of ensembl here you would notice greater mapping. However, since the org.Mm.eg.db cannot easily be downgraded, and since we want the most recent GO terms which are available, we may have to resign ourselves to not having all genes map. Your gene list may actually quite old. Your data were originally mapped with an annotation from 2011.

In any case, orgDbs and BiomaRt are updated in different ways and separately. It's best to choose one method or the other when doing analysis rather than mixing them so any term mismatches won't affect the analysis. Here, we will use biomaRt.
```{r ensembl}
ensembl_114 <- useEnsembl(biomart = 'genes', 
                          dataset = 'mmusculus_gene_ensembl',
                          version = 114)
# Many names in your gene list are of different types or are synonyms
# Therefore, we must search and combine the results. 
# Doing this procedure brings us from 10% no-maps to 5% no-maps
# Search across different identifier types
results <- list()

synonyms <- getBM(
  attributes = c("external_gene_name", "ensembl_gene_id", "external_synonym", "mgi_symbol"),
  filters = "external_synonym",
  values = rownames(res_tableOE),
  mart = ensembl_114
)

name <- getBM(
  attributes = c("external_gene_name", "ensembl_gene_id", "external_synonym", "mgi_symbol"),
  filters = "external_gene_name",
  values = rownames(res_tableOE),
  mart = ensembl_114
)

mgi <- getBM(
  attributes = c("external_gene_name", "ensembl_gene_id", "external_synonym", "mgi_symbol"),
  filters = "mgi_symbol",
  values = rownames(res_tableOE),
  mart = ensembl_114
)

# Combine results
results <- merge(mgi, name, all = TRUE)
results <- merge(results, synonyms, all = TRUE)

# Here, we extract all of the GO terms from the biomart
go_terms <- getBM(attributes = c("go_id", "ensembl_gene_id", "name_1006"),
                  mart = ensembl_114)
#setdiff(rownames(res_tableOE), results$external_gene_name)

```

The gene names can map to more than one Ensembl ID (some genes change ID over time),
so we need to remove duplicate IDs prior to assessing enriched GO terms
In other words, the gene names we are converting from are less precise than the ones we are converting to.
Therefore, we cannot know which Ensembl gene ID is the correct one. So just pick one

```{r duplicates}

non_duplicates <- which(duplicated(results$ensembl_gene_id) == FALSE)

results <- results[non_duplicates, ]

## Merge the Ensembl IDs with the results    
merged_gene_ids <- merge(x=res_tableOE, y=results, by.x="row.names", by.y="external_gene_name")            
```

Remember, Overrepresentation analysis requires us to decide first which genes are significant.
```{r extract_results}
## Extract significant results
sigOE <- subset(merged_gene_ids, padj < 0.05)

sigOE_genes <- as.character(sigOE$ensembl_gene_id)

## Create background dataset for hypergeometric testing using all genes tested for significance in the results                
allOE_genes <- as.character(merged_gene_ids$ensembl_gene_id)
```

Here, we begin the actual overrepresentation analysis.
```{r overrepresentation}
# Overrepresentation analysis

# Just to show, this is what it would look like if we used the orgDB. You can see
# if we simply load the orgdb library we can make it much easier on ourselves and
# we don't have to extract the GO terms ourselves. Still, orgdb is static, not update
# as frequently. In case you need to take the more complex route, we show it here.
# ego <- enrichGO(gene = sigOE_genes,
#                universe = allOE_genes,
#                keyType = "ENSEMBL",
#                OrgDb = org.Mm.eg.db,
#                ont = "BP",
#                pAdjustMethod = "BH",
#                qvalueCutoff = 0.05,
#                readable = TRUE)

# Here we make an object to map gene ids to go terms. Go terms contain names like
# GO:0006414 
term2gene <- go_terms[,c("go_id", "ensembl_gene_id")]
# This object maps the GO terms to their names.
# GO:0006414 stands for "translational elongation"
term2name <- unique(go_terms[,c("go_id", "name_1006")])

# Notice the qvalue cutoff. This accounts for all the different tests that may be run
# and applies multiple testing correction considering the number of tests. 
ego <- enricher(gene = sigOE_genes,
                universe = allOE_genes, # if left blank will be all known genes
                qvalueCutoff = 0.05, # pvalue = single test, q-value accounts for all tests
                pAdjustMethod = "BH",
                TERM2GENE = term2gene,
                TERM2NAME = term2name)

## Dotplot gives top 15 genes by gene ratio (# genes related to GO term / total number of sig genes), not padj.
dotplot(ego, showCategory=15)

# Feel free to explore the ego object and make custom plots using it

```

Next, we can make different plots using this enrichment. Finally, we
can also perform GSEA

```{r mitch}
# Download gene sets
# We'll download these from GSEA MSigDB https://www.gsea-msigdb.org/gsea/msigdb/mouse/collections.jsp
# Select gene symbol canonical pathways. Perhaps double check if that makes sense with Alyssa
download.file("https://reactome.org/download/current/ReactomePathways.gmt.zip", destfile="ReactomePathways.gmt.zip")
unzip("ReactomePathways.gmt.zip")
#genesets <- gmt_import("ReactomePathways.gmt")
genesets <- gmt_import("/app/Downloads/m2.cp.v2025.1.Mm.symbols.gmt.txt")

x <- list("dge1"=merged_gene_ids)
y <- mitch_import(x, DEtype="DESeq2", geneIDcol="Row.names")
res <- mitch_calc(y, genesets, priority="significance", minsetsize=5)

## NB TRY OTHER TECHNIQUES IN THE EXAMPLEFILE FIRST
```